<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencocok Nomor Seri Barang</title>
    <!-- Memuat Tailwind CSS untuk styling responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Library html5-qrcode untuk pemindaian barcode/QR code -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Style untuk area pemindaian kamera */
        #reader {
            width: 100%;
            max-width: 400px; /* Batasi lebar pada layar besar */
            margin: 0 auto;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            overflow: hidden;
            display: none; /* Sembunyikan secara default */
        }
        /* Style Modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            visibility: hidden;
        }
        .modal.open {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }
    </style>
</head>
<body class="p-4 sm:p-6 min-h-screen bg-gray-50">

    <div class="max-w-xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Pencocok Nomor Seri Cepat</h1>
        
        <!-- Area Pemindai Barcode (DI ATAS) -->
        <div class="bg-white p-5 rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pemindai</h2>
            <div id="reader"></div>
            
            <div class="flex flex-col space-y-4 mt-4">
                <button id="startButton" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-xl shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.02] active:scale-95">
                    Mulai Pindai Barcode
                </button>
                <button id="stopButton" class="w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-xl shadow-md hover:bg-red-600 transition duration-150 transform hover:scale-[1.02] active:scale-95" style="display: none;">
                    Stop Pemindaian
                </button>
            </div>
            
        </div>

        <!-- Area Input Daftar Nomor Seri (DI BAWAH) -->
        <div class="bg-white p-5 rounded-xl shadow-lg mb-6">
            <label for="serialList" class="block text-lg font-semibold text-gray-700 mb-2">Daftar Nomor Seri Target</label>
            <p class="text-sm text-gray-500 mb-2">Nomor yang valid akan dihapus otomatis dari daftar ini.</p>
            <textarea id="serialList" rows="8" placeholder="Contoh:&#10;SN12345678&#10;SN12345679&#10;SN12345680" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm"></textarea>
            <div id="listCount" class="text-xs text-gray-500 mt-1">0 nomor seri dimuat.</div>
        </div>
        
    </div>

    <!-- Modal Pop-up Hasil Pencocokan -->
    <div id="validationModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0">
        <div class="bg-white w-full max-w-sm p-6 rounded-xl shadow-2xl transform transition-all duration-300 scale-95" id="modalContent">
            <h3 class="text-2xl font-bold mb-3" id="modalTitle">Hasil</h3>
            <p class="mb-4 text-gray-600" id="modalMessage"></p>
            <div class="text-lg font-mono break-all font-semibold" id="modalSerial"></div>
            <button id="closeModalButton" class="mt-6 w-full py-2 rounded-lg text-white font-semibold shadow-md transition duration-150">Tutup & Lanjutkan Scan</button>
        </div>
    </div>

    <script>
        // --- Konfigurasi Firebase/Firestore (Boilerplate Wajib) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Variabel untuk menyimpan Set Nomor Seri dan Instance Scanner
        let serialNumberSet = new Set();
        let html5QrcodeScanner = null;
        const readerId = "reader"; // ID elemen div kamera

        // Elemen DOM
        const serialListElement = document.getElementById('serialList');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const listCountElement = document.getElementById('listCount');
        
        // Elemen Modal
        const validationModal = document.getElementById('validationModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalSerial = document.getElementById('modalSerial');
        const closeModalButton = document.getElementById('closeModalButton');

        /**
         * Mengambil data dari Set dan memperbarui konten textarea.
         * Ini dipanggil setelah penghapusan nomor seri yang valid.
         */
        function updateListTextarea() {
            const remainingSerials = Array.from(serialNumberSet).join('\n');
            serialListElement.value = remainingSerials;
            loadSerialList(); // Memuat ulang set dan menghitung ulang
        }
        
        /**
         * Menghapus nomor seri yang berhasil dipindai dari Set dan Textarea.
         * @param {string} serial - Nomor seri yang akan dihapus.
         */
        function removeSerialFromList(serial) {
            if (serialNumberSet.has(serial)) {
                serialNumberSet.delete(serial);
                updateListTextarea();
                console.log(`Nomor seri dihapus: ${serial}. Sisa: ${serialNumberSet.size}`);
            }
        }

        /**
         * Memuat dan membersihkan daftar nomor seri dari textarea.
         */
        function loadSerialList() {
            const listText = serialListElement.value;
            // Pisahkan berdasarkan baris baru, hapus spasi kosong, dan filter baris kosong
            const serials = listText.split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            // Buat Set baru untuk pencarian cepat O(1)
            serialNumberSet = new Set(serials);
            listCountElement.textContent = `${serialNumberSet.size} nomor seri dimuat.`;
            
            if (serialNumberSet.size === 0) {
                // Jika daftar kosong, tampilkan pesan agar pengguna tahu
            }
            return true;
        }
        
        // Memperbarui hitungan setiap kali input berubah
        serialListElement.addEventListener('input', loadSerialList);

        /**
         * Menampilkan modal pop-up dengan hasil.
         * @param {string} title - Judul modal.
         * @param {string} message - Pesan di modal.
         * @param {string} serial - Nomor seri yang dipindai.
         * @param {boolean} isSuccess - Status keberhasilan (untuk styling).
         */
        function showModal(title, message, serial, isSuccess) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalSerial.textContent = serial;
            
            closeModalButton.classList.remove('bg-green-600', 'bg-red-600');
            modalContent.classList.remove('scale-95');

            if (isSuccess) {
                modalTitle.classList.remove('text-red-600');
                modalTitle.classList.add('text-green-600');
                closeModalButton.classList.add('bg-green-600');
            } else {
                modalTitle.classList.remove('text-green-600');
                modalTitle.classList.add('text-red-600');
                closeModalButton.classList.add('bg-red-600');
            }
            
            validationModal.classList.add('open');
            modalContent.classList.add('scale-100');
        }

        /**
         * Menyembunyikan modal pop-up dan melanjutkan pemindaian jika sebelumnya di-pause.
         */
        function hideModal() {
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            validationModal.classList.remove('open');
            
            // Lanjutkan pemindaian jika scanner sedang aktif/paused
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                 html5QrcodeScanner.resume();
            }
        }

        /**
         * Callback saat pemindaian berhasil.
         * @param {string} decodedText - Hasil pemindaian barcode/QR.
         */
        function onScanSuccess(decodedText) {
            const serial = decodedText.trim();
            const isMatch = serialNumberSet.has(serial);

            if (isMatch) {
                // HENTIKAN SEMENTARA SCANNER untuk mencegah pemindaian kedua
                if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                    html5QrcodeScanner.pause();
                }

                // Panggil modal sukses
                showModal(
                    "✅ PENCARIAN BERHASIL!",
                    "Nomor seri ini DITEMUKAN dalam daftar target. Telah dihapus dari daftar.",
                    serial,
                    true
                );
                // Hapus item dari daftar dan perbarui textarea
                removeSerialFromList(serial);
            } else {
                // Panggil modal gagal (pemindai tetap aktif)
                showModal(
                    "❌ TIDAK DITEMUKAN",
                    "Nomor seri ini TIDAK ADA dalam daftar target.",
                    serial,
                    false
                );
            }
        }

        // Event listener untuk tombol tutup modal
        closeModalButton.addEventListener('click', hideModal);

        /**
         * Callback saat terjadi kesalahan pemindaian (dibiarkan kosong).
         */
        function onScanError(errorMessage) {
            // Biarkan kosong untuk mencegah spamming console/UI
        }

        /**
         * Memulai pemindaian kamera.
         */
        function startScanner() {
            if (!loadSerialList()) return; 

            // Sembunyikan/tampilkan tombol
            serialListElement.disabled = true;
            startButton.style.display = 'none';
            stopButton.style.display = 'block';
            document.getElementById(readerId).style.display = 'block';

            // Inisialisasi dan mulai scanner
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    readerId, 
                    { 
                        fps: 10, 
                        qrbox: {width: 250, height: 150},
                        // Konfigurasi kamera belakang (environment) yang stabil
                        videoConstraints: { 
                            facingMode: { exact: "environment" } 
                        },
                        rememberLastUsedCamera: true
                    },
                    /* verbose= */ false
                );
            }
            
            // Render scanner hanya jika belum berjalan
            if (!html5QrcodeScanner.isScanning) {
                 html5QrcodeScanner.render(onScanSuccess, onScanError);
            }
        }

        /**
         * Menghentikan pemindaian kamera.
         */
        async function stopScanner() {
            if (html5QrcodeScanner) {
                try {
                    await html5QrcodeScanner.clear();
                    // Setelah clear berhasil:
                    document.getElementById(readerId).style.display = 'none';
                    startButton.style.display = 'block';
                    stopButton.style.display = 'none';
                    serialListElement.disabled = false;
                    hideModal(); // Pastikan modal tertutup
                } catch (err) {
                    console.error("Gagal menghentikan scanner:", err);
                    // Tidak perlu menampilkan error di UI, cukup di konsol.
                }
            }
        }

        // Event Listeners untuk tombol Start/Stop
        startButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);

        // Muat daftar awal saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
             // Beri contoh nilai default
            serialListElement.value = "A123-ABC-1\nB456-DEF-2\nC789-GHI-3\nD101-JKL-4";
            loadSerialList();
        });
        
    </script>
</body>
</html>
