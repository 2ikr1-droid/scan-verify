<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencocok Nomor Seri Barang</title>
    <!-- Memuat Tailwind CSS untuk styling responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Library html5-qrcode untuk pemindaian barcode/QR code -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Style untuk area pemindaian kamera */
        #reader {
            width: 100%;
            max-width: 400px; /* Batasi lebar pada layar besar */
            margin: 0 auto;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            overflow: hidden;
            display: none; /* Sembunyikan secara default */
        }
    </style>
</head>
<body class="p-4 sm:p-6 min-h-screen bg-gray-50">

    <div class="max-w-xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Pencocok Nomor Seri</h1>
        <p class="text-sm text-gray-600 mb-4 text-center">Tempelkan daftar nomor seri Anda (satu nomor per baris) di bawah ini, lalu mulai pemindai.</p>

        <!-- Area Input Daftar Nomor Seri -->
        <div class="bg-white p-5 rounded-xl shadow-lg mb-6">
            <label for="serialList" class="block text-lg font-semibold text-gray-700 mb-2">Daftar Nomor Seri Target</label>
            <textarea id="serialList" rows="8" placeholder="Contoh:&#10;SN12345678&#10;SN12345679&#10;SN12345680" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 text-sm"></textarea>
            <div id="listCount" class="text-xs text-gray-500 mt-1">0 nomor seri dimuat.</div>
        </div>

        <!-- Tombol dan Area Scanner -->
        <div class="flex flex-col space-y-4">
            <button id="startButton" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-xl shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.02] active:scale-95">
                Mulai Pindai Barcode
            </button>
            <button id="stopButton" class="w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-xl shadow-md hover:bg-red-600 transition duration-150 transform hover:scale-[1.02] active:scale-95" style="display: none;">
                Stop Pemindaian
            </button>
        </div>

        <div id="reader" class="mt-6"></div>

        <!-- Area Hasil -->
        <div class="mt-8 p-5 rounded-xl shadow-xl transition-all duration-300" id="resultCard">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Hasil Pemindaian Terakhir</h2>
            <div id="scanResult" class="text-2xl font-mono break-all text-gray-700">Belum ada hasil.</div>
            <div id="matchStatus" class="text-xl font-bold mt-3"></div>
        </div>
    </div>

    <script>
        // --- Konfigurasi Firebase/Firestore (Boilerplate Wajib) ---
        // Variabel global ini harus didefinisikan meskipun tidak digunakan dalam logika ini.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Variabel untuk menyimpan Set Nomor Seri dan Instance Scanner
        let serialNumberSet = new Set();
        let html5QrcodeScanner = null;
        const readerId = "reader"; // ID elemen div kamera

        // Elemen DOM
        const serialListElement = document.getElementById('serialList');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const resultCard = document.getElementById('resultCard');
        const scanResultElement = document.getElementById('scanResult');
        const matchStatusElement = document.getElementById('matchStatus');
        const listCountElement = document.getElementById('listCount');

        /**
         * Memuat dan membersihkan daftar nomor seri dari textarea.
         */
        function loadSerialList() {
            const listText = serialListElement.value;
            // Pisahkan berdasarkan baris baru, hapus spasi kosong, dan filter baris kosong
            const serials = listText.split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            // Buat Set baru untuk pencarian cepat O(1)
            serialNumberSet = new Set(serials);
            listCountElement.textContent = `${serialNumberSet.size} nomor seri dimuat.`;
            
            // Log daftar yang dimuat (Opsional untuk debug)
            console.log("Daftar Nomor Seri Dimuat:", serialNumberSet);

            if (serialNumberSet.size === 0) {
                matchStatusElement.innerHTML = `<span class="text-red-600">ERROR:</span> Silakan masukkan nomor seri terlebih dahulu.`;
                return false;
            }
            return true;
        }
        
        // Memperbarui hitungan setiap kali input berubah
        serialListElement.addEventListener('input', loadSerialList);

        /**
         * Callback saat pemindaian berhasil.
         * @param {string} decodedText - Hasil pemindaian barcode/QR.
         * @param {object} decodedResult - Detail hasil pemindaian.
         */
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan berhasil: ${decodedText}`);
            
            // Tampilkan hasil pemindaian
            scanResultElement.textContent = decodedText;
            
            // Bersihkan styling sebelumnya
            resultCard.classList.remove('bg-red-100', 'bg-green-100');
            matchStatusElement.className = 'text-xl font-bold mt-3';

            // Cocokkan hasil dengan Set
            const isMatch = serialNumberSet.has(decodedText.trim());

            if (isMatch) {
                matchStatusElement.textContent = "✅ DITEMUKAN (Match)";
                matchStatusElement.classList.add('text-green-600');
                resultCard.classList.add('bg-green-100');
                // Hentikan pemindaian setelah match berhasil (opsional, bisa diubah jika ingin scan berulang)
                // stopScanner();
            } else {
                matchStatusElement.textContent = "❌ TIDAK DITEMUKAN (No Match)";
                matchStatusElement.classList.add('text-red-600');
                resultCard.classList.add('bg-red-100');
            }
        }

        /**
         * Callback saat terjadi kesalahan pemindaian (misalnya tidak ada barcode terdeteksi).
         * @param {string} errorMessage - Pesan kesalahan.
         */
        function onScanError(errorMessage) {
            // Kita biarkan ini kosong untuk mencegah spamming console/UI dengan notifikasi "no code found"
            // console.warn(`Scan error: ${errorMessage}`);
        }

        /**
         * Memulai pemindaian kamera.
         */
        function startScanner() {
            if (!loadSerialList()) return; // Cek dan muat daftar, batalkan jika kosong

            // Sembunyikan input dan tombol mulai
            serialListElement.disabled = true;
            startButton.style.display = 'none';
            stopButton.style.display = 'block';
            document.getElementById(readerId).style.display = 'block';

            // Kosongkan hasil sebelumnya
            scanResultElement.textContent = "Arahkan kamera ke barcode...";
            matchStatusElement.textContent = "";
            resultCard.classList.remove('bg-red-100', 'bg-green-100');

            // Inisialisasi dan mulai scanner
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    readerId, 
                    { 
                        fps: 10, 
                        qrbox: {width: 250, height: 150},
                        // Gunakan kamera belakang secara eksplisit (lebih andal menggunakan videoConstraints)
                        videoConstraints: { 
                            facingMode: { exact: "environment" } 
                        },
                        rememberLastUsedCamera: true
                    },
                    /* verbose= */ false
                );
            }
            
            // Pastikan scanner belum berjalan sebelum memanggil render
            if (!html5QrcodeScanner.isScanning) {
                 html5QrcodeScanner.render(onScanSuccess, onScanError);
            }
        }

        /**
         * Menghentikan pemindaian kamera.
         */
        async function stopScanner() {
            if (html5QrcodeScanner) {
                try {
                    await html5QrcodeScanner.clear();
                    // Setelah clear berhasil:
                    document.getElementById(readerId).style.display = 'none';
                    startButton.style.display = 'block';
                    stopButton.style.display = 'none';
                    serialListElement.disabled = false;
                    scanResultElement.textContent = "Pemindaian dihentikan.";
                    matchStatusElement.textContent = "";
                } catch (err) {
                    console.error("Gagal menghentikan scanner:", err);
                    matchStatusElement.textContent = `Error stop: ${err.message}`;
                }
            }
        }

        // Event Listeners untuk tombol
        startButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);

        // Muat daftar awal saat halaman dimuat (jika ada nilai default)
        document.addEventListener('DOMContentLoaded', () => {
             // Beri contoh nilai default
            serialListElement.value = "A123-ABC-1\nB456-DEF-2\nC789-GHI-3\nD101-JKL-4";
            loadSerialList();
        });
        
    </script>
</body>
</html>
